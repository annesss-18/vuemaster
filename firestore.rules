// firestore.rules
// Comprehensive Firestore Security Rules for VueMaster
// Deploy with: firebase deploy --only firestore:rules

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is the owner
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Users collection
    // - Users can only read and write their own profile
    // - User document ID must match authentication UID
    match /users/{userId} {
      allow read: if isOwner(userId);
      allow create: if isOwner(userId) && 
                       request.resource.data.keys().hasOnly(['name', 'email']);
      allow update: if isOwner(userId) && 
                       request.resource.data.keys().hasOnly(['name', 'email']);
      allow delete: if false; // Prevent user deletion through client
    }
    
    // Interviews collection
    // - Users can create interviews for themselves
    // - Users can read/update/delete their own interviews
    // - Anyone can read finalized (public) interviews
    match /interviews/{interviewId} {
      // Read access: own interviews OR finalized interviews
      allow read: if isAuthenticated() && 
                     (resource.data.userId == request.auth.uid || 
                      resource.data.finalized == true);
      
      // Create: must be authenticated and set userId to own UID
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.keys().hasAll(['userId', 'createdAt', 'status']) &&
                       request.resource.data.finalized == false; // Start as non-finalized
      
      // Update: only own interviews
      allow update: if isOwner(resource.data.userId) &&
                       request.resource.data.userId == resource.data.userId; // Prevent userId change
      
      // Delete: only own interviews
      allow delete: if isOwner(resource.data.userId);
    }
    
    // Feedback collection
    // - Users can read their own feedback
    // - Users can create feedback for their own interviews
    // - Feedback is immutable once created
    match /feedback/{feedbackId} {
      // Read: only own feedback
      allow read: if isOwner(resource.data.userId);
      
      // Create: must be authenticated, set userId to own UID, and reference valid interview
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.keys().hasAll(['userId', 'interviewId', 'createdAt']) &&
                       exists(/databases/$(database)/documents/interviews/$(request.resource.data.interviewId));
      
      // Update and Delete: Feedback is immutable
      allow update: if false;
      allow delete: if false;
    }
    
    // Deny all other collections by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

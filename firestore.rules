rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isValidTemplate() {
      let data = request.resource.data;
      return data.keys().hasAll(['creatorId', 'role', 'level', 'type', 'techStack', 'jobDescription', 'baseQuestions', 'isPublic', 'createdAt']) &&
             data.level in ['Junior', 'Mid', 'Senior', 'Staff', 'Executive'] &&
             data.type in ['Screening', 'Technical', 'System Design', 'Behavioral', 'Case Study', 'HR', 'Mixed'] &&
             data.techStack is list &&
             data.baseQuestions is list &&
             data.baseQuestions.size() >= 1 &&
             data.baseQuestions.size() <= 20;
    }
    
    function isValidSession() {
      let data = request.resource.data;
      return data.keys().hasAll(['templateId', 'userId', 'status', 'startedAt']) &&
             data.status in ['setup', 'active', 'completed'] &&
             data.userId == request.auth.uid;
    }
    
    // Users collection
    match /users/{userId} {
      allow read: if isOwner(userId);
      allow create: if isOwner(userId) && 
                       request.resource.data.keys().hasOnly(['name', 'email']);
      allow update: if isOwner(userId) && 
                       request.resource.data.keys().hasOnly(['name', 'email']);
      allow delete: if false;
    }
    
    // Interview Templates (NEW MODEL)
    match /interview_templates/{templateId} {
      // Public templates readable by all, private only by creator
      allow read: if resource.data.isPublic == true || 
                     isOwner(resource.data.creatorId);
      
      // Only authenticated users can create
      allow create: if isAuthenticated() && 
                       isOwner(request.resource.data.creatorId) &&
                       isValidTemplate();
      
      // Only creator can update their own templates
      allow update: if isOwner(resource.data.creatorId) &&
                       request.resource.data.creatorId == resource.data.creatorId; // Prevent changing creator
      
      // Only creator can delete
      allow delete: if isOwner(resource.data.creatorId);
    }
    
    // Interview Sessions (NEW MODEL)
    match /interview_sessions/{sessionId} {
      // Only owner can read their sessions
      allow read: if isOwner(resource.data.userId);
      
      // Create session - must reference valid template
      allow create: if isAuthenticated() && 
                       isValidSession() &&
                       exists(/databases/$(database)/documents/interview_templates/$(request.resource.data.templateId));
      
      // Only owner can update (for resume upload, status changes)
      allow update: if isOwner(resource.data.userId) &&
                       request.resource.data.userId == resource.data.userId && // Prevent changing owner
                       request.resource.data.templateId == resource.data.templateId; // Prevent changing template
      
      // Only owner can delete
      allow delete: if isOwner(resource.data.userId);
    }
    
    // Feedback collection
    match /feedback/{feedbackId} {
      // Only owner can read
      allow read: if isOwner(resource.data.userId);
      
      // Create feedback - must reference valid session or legacy interview
      allow create: if isAuthenticated() && 
                       isOwner(request.resource.data.userId) &&
                       request.resource.data.keys().hasAll(['userId', 'interviewId', 'totalScore', 'createdAt']) &&
                       (
                         exists(/databases/$(database)/documents/interview_sessions/$(request.resource.data.interviewId)) ||
                         exists(/databases/$(database)/documents/interviews/$(request.resource.data.interviewId))
                       );
      
      // Feedback is immutable
      allow update: if false;
      allow delete: if false;
    }
    
    // LEGACY: Keep interviews collection for feedback references during transition
        
    // Deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}